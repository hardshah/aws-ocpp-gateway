"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.createBackupConfig = exports.createProcessingConfig = exports.createEncryptionConfig = exports.createBufferingHints = exports.createLoggingOptions = void 0;
const logs = require("aws-cdk-lib/aws-logs");
const s3 = require("aws-cdk-lib/aws-s3");
const constructs_1 = require("constructs");
function createLoggingOptions(scope, props) {
    if (props.logging === false && props.logGroup) {
        throw new Error('logging cannot be set to false when logGroup is provided');
    }
    if (props.logging !== false || props.logGroup) {
        const logGroup = props.logGroup ?? constructs_1.Node.of(scope).tryFindChild('LogGroup') ?? new logs.LogGroup(scope, 'LogGroup');
        const logGroupGrant = logGroup.grantWrite(props.role);
        return {
            loggingOptions: {
                enabled: true,
                logGroupName: logGroup.logGroupName,
                logStreamName: logGroup.addStream(props.streamId).logStreamName,
            },
            dependables: [logGroupGrant],
        };
    }
    return undefined;
}
exports.createLoggingOptions = createLoggingOptions;
function createBufferingHints(interval, size) {
    if (!interval && !size) {
        return undefined;
    }
    const intervalInSeconds = interval?.toSeconds() ?? 300;
    if (intervalInSeconds > 900) {
        throw new Error(`Buffering interval must be less than 900 seconds. Buffering interval provided was ${intervalInSeconds} seconds.`);
    }
    const sizeInMBs = size?.toMebibytes() ?? 5;
    if (sizeInMBs < 1 || sizeInMBs > 128) {
        throw new Error(`Buffering size must be between 1 and 128 MiBs. Buffering size provided was ${sizeInMBs} MiBs.`);
    }
    return { intervalInSeconds, sizeInMBs };
}
exports.createBufferingHints = createBufferingHints;
function createEncryptionConfig(role, encryptionKey) {
    encryptionKey?.grantEncryptDecrypt(role);
    return encryptionKey
        ? { kmsEncryptionConfig: { awskmsKeyArn: encryptionKey.keyArn } }
        : undefined;
}
exports.createEncryptionConfig = createEncryptionConfig;
function createProcessingConfig(scope, role, dataProcessor) {
    return dataProcessor
        ? {
            enabled: true,
            processors: [renderDataProcessor(dataProcessor, scope, role)],
        }
        : undefined;
}
exports.createProcessingConfig = createProcessingConfig;
function renderDataProcessor(processor, scope, role) {
    const processorConfig = processor.bind(scope, { role });
    const parameters = [{ parameterName: 'RoleArn', parameterValue: role.roleArn }];
    parameters.push(processorConfig.processorIdentifier);
    if (processor.props.bufferInterval) {
        parameters.push({ parameterName: 'BufferIntervalInSeconds', parameterValue: processor.props.bufferInterval.toSeconds().toString() });
    }
    if (processor.props.bufferSize) {
        parameters.push({ parameterName: 'BufferSizeInMBs', parameterValue: processor.props.bufferSize.toMebibytes().toString() });
    }
    if (processor.props.retries) {
        parameters.push({ parameterName: 'NumberOfRetries', parameterValue: processor.props.retries.toString() });
    }
    return {
        type: processorConfig.processorType,
        parameters,
    };
}
function createBackupConfig(scope, role, props) {
    if (!props || (props.mode === undefined && !props.bucket)) {
        return undefined;
    }
    const bucket = props.bucket ?? new s3.Bucket(scope, 'BackupBucket');
    const bucketGrant = bucket.grantReadWrite(role);
    const { loggingOptions, dependables: loggingDependables } = createLoggingOptions(scope, {
        logging: props.logging,
        logGroup: props.logGroup,
        role,
        streamId: 'S3Backup',
    }) ?? {};
    return {
        backupConfig: {
            bucketArn: bucket.bucketArn,
            roleArn: role.roleArn,
            prefix: props.dataOutputPrefix,
            errorOutputPrefix: props.errorOutputPrefix,
            bufferingHints: createBufferingHints(props.bufferingInterval, props.bufferingSize),
            compressionFormat: props.compression?.value,
            encryptionConfiguration: createEncryptionConfig(role, props.encryptionKey),
            cloudWatchLoggingOptions: loggingOptions,
        },
        dependables: [bucketGrant, ...(loggingDependables ?? [])],
    };
}
exports.createBackupConfig = createBackupConfig;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGVscGVycy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImhlbHBlcnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBSUEsNkNBQTZDO0FBQzdDLHlDQUF5QztBQUV6QywyQ0FBMEQ7QUFzRDFELFNBQWdCLG9CQUFvQixDQUFDLEtBQWdCLEVBQUUsS0FBOEI7SUFDbkYsSUFBSSxLQUFLLENBQUMsT0FBTyxLQUFLLEtBQUssSUFBSSxLQUFLLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDOUMsTUFBTSxJQUFJLEtBQUssQ0FBQywwREFBMEQsQ0FBQyxDQUFDO0lBQzlFLENBQUM7SUFDRCxJQUFJLEtBQUssQ0FBQyxPQUFPLEtBQUssS0FBSyxJQUFJLEtBQUssQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUM5QyxNQUFNLFFBQVEsR0FBRyxLQUFLLENBQUMsUUFBUSxJQUFJLGlCQUFJLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQW1CLElBQUksSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxVQUFVLENBQUMsQ0FBQztRQUNySSxNQUFNLGFBQWEsR0FBRyxRQUFRLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN0RCxPQUFPO1lBQ0wsY0FBYyxFQUFFO2dCQUNkLE9BQU8sRUFBRSxJQUFJO2dCQUNiLFlBQVksRUFBRSxRQUFRLENBQUMsWUFBWTtnQkFDbkMsYUFBYSxFQUFFLFFBQVEsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDLGFBQWE7YUFDaEU7WUFDRCxXQUFXLEVBQUUsQ0FBQyxhQUFhLENBQUM7U0FDN0IsQ0FBQztJQUNKLENBQUM7SUFDRCxPQUFPLFNBQVMsQ0FBQztBQUNuQixDQUFDO0FBakJELG9EQWlCQztBQUVELFNBQWdCLG9CQUFvQixDQUNsQyxRQUF1QixFQUN2QixJQUFlO0lBRWYsSUFBSSxDQUFDLFFBQVEsSUFBSSxDQUFD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QUMsa0JBQWtCLElBQUksRUFBRSxDQUFDLENBQUM7S0FDMUQsQ0FBQztBQUNKLENBQUM7QUE1QkQsZ0RBNEJDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgaWFtIGZyb20gJ2F3cy1jZGstbGliL2F3cy1pYW0nO1xuaW1wb3J0ICogYXMgZmlyZWhvc2UgZnJvbSAnQGF3cy1jZGsvYXdzLWtpbmVzaXNmaXJlaG9zZS1hbHBoYSc7XG5pbXBvcnQgeyBDZm5EZWxpdmVyeVN0cmVhbSB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1raW5lc2lzZmlyZWhvc2UnO1xuaW1wb3J0ICogYXMga21zIGZyb20gJ2F3cy1jZGstbGliL2F3cy1rbXMnO1xuaW1wb3J0ICogYXMgbG9ncyBmcm9tICdhd3MtY2RrLWxpYi9hd3MtbG9ncyc7XG5pbXBvcnQgKiBhcyBzMyBmcm9tICdhd3MtY2RrLWxpYi9hd3MtczMnO1xuaW1wb3J0ICogYXMgY2RrIGZyb20gJ2F3cy1jZGstbGliL2NvcmUnO1xuaW1wb3J0IHsgQ29uc3RydWN0LCBJRGVwZW5kYWJsZSwgTm9kZSB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0IHsgRGVzdGluYXRpb25TM0JhY2t1cFByb3BzIH0gZnJvbSAnLi4vY29tbW9uJztcblxuZXhwb3J0IGludGVyZmFjZSBEZXN0aW5hdGlvbkxvZ2dpbmdQcm9wcyB7XG4gIC8qKlxuICAgKiBJZiB0cnVlLCBsb2cgZXJyb3JzIHdoZW4gZGF0YSB0cmFuc2Zvcm1hdGlvbiBvciBkYXRhIGRlbGl2ZXJ5IGZhaWxzLlxuICAgKlxuICAgKiBJZiBgbG9nR3JvdXBgIGlzIHByb3ZpZGVkLCB0aGlzIHdpbGwgYmUgaW1wbGljaXRseSBzZXQgdG8gYHRydWVgLlxuICAgKlxuICAgKiBAZGVmYXVsdCB0cnVlIC0gZXJyb3JzIGFyZSBsb2dnZWQuXG4gICAqL1xuICByZWFkb25seSBsb2dnaW5nPzogYm9vbGVhbjtcblxuICAvKipcbiAgICogVGhlIENsb3VkV2F0Y2ggbG9nIGdyb3VwIHdoZXJlIGxvZyBzdHJlYW1zIHdpbGwgYmUgY3JlYXRlZCB0byBob2xkIGVycm9yIGxvZ3MuXG4gICAqXG4gICAqIEBkZWZhdWx0IC0gaWYgYGxvZ2dpbmdgIGlzIHNldCB0byBgdHJ1ZWAsIGEgbG9nIGdyb3VwIHdpbGwgYmUgY3JlYXRlZCBmb3IgeW91LlxuICAgKi9cbiAgcmVhZG9ubHkgbG9nR3JvdXA/OiBsb2dzLklMb2dHcm91cDtcblxuICAvKipcbiAgICogVGhlIElBTSByb2xlIGFzc29jaWF0ZWQgd2l0aCB0aGlzIGRlc3RpbmF0aW9uLlxuICAgKi9cbiAgcmVhZG9ubHkgcm9sZTogaWFtLklSb2xlO1xuXG4gIC8qKlxuICAgKiBUaGUgSUQgb2YgdGhlIHN0cmVhbSB0aGF0IGlzIGNyZWF0ZWQgaW4gdGhlIGxvZyBncm91cCB3aGVyZSBsb2dzIHdpbGwgYmUgcGxhY2VkLlxuICAgKlxuICAgKiBNdXN0IGJlIHVuaXF1ZSB3aXRoaW4gdGhlIGxvZyBncm91cCwgc28gc2hvdWxkIGJlIGRpZmZlcmVudCBldmVyeSB0aW1lIHRoaXMgZnVuY3Rpb24gaXMgY2FsbGVkLlxuICAgKi9cbiAgcmVhZG9ubHkgc3RyZWFtSWQ6IHN0cmluZztcbn1cblxuaW50ZXJmYWNlIENvbmZpZ1dpdGhEZXBlbmRhYmxlcyB7XG4gIC8qKlxuICAgKiBSZXNvdXJjZXMgdGhhdCB3ZXJlIGNyZWF0ZWQgYnkgdGhlIHN1Yi1jb25maWcgY3JlYXRvciB0aGF0IG11c3QgYmUgZGVwbG95ZWQgYmVmb3JlIHRoZSBkZWxpdmVyeSBzdHJlYW0gaXMgZGVwbG95ZWQuXG4gICAqL1xuICByZWFkb25seSBkZXBlbmRhYmxlczogSURlcGVuZGFibGVbXTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBEZXN0aW5hdGlvbkxvZ2dpbmdDb25maWcgZXh0ZW5kcyBDb25maWdXaXRoRGVwZW5kYWJsZXMge1xuICAvKipcbiAgICogTG9nZ2luZyBvcHRpb25zIHRoYXQgd2lsbCBiZSBpbmplY3RlZCBpbnRvIHRoZSBkZXN0aW5hdGlvbiBjb25maWd1cmF0aW9uLlxuICAgKi9cbiAgcmVhZG9ubHkgbG9nZ2luZ09wdGlvbnM6IENmbkRlbGl2ZXJ5U3RyZWFtLkNsb3VkV2F0Y2hMb2dnaW5nT3B0aW9uc1Byb3BlcnR5O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIERlc3RpbmF0aW9uQmFja3VwQ29uZmlnIGV4dGVuZHMgQ29uZmlnV2l0aERlcGVuZGFibGVzIHtcbiAgLyoqXG4gICAqIFMzIGJhY2t1cCBjb25maWd1cmF0aW9uIHRoYXQgd2lsbCBiZSBpbmplY3RlZCBpbnRvIHRoZSBkZXN0aW5hdGlvbiBjb25maWd1cmF0aW9uLlxuICAgKi9cbiAgcmVhZG9ubHkgYmFja3VwQ29uZmlnOiBDZm5EZWxpdmVyeVN0cmVhbS5TM0Rlc3RpbmF0aW9uQ29uZmlndXJhdGlvblByb3BlcnR5O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlTG9nZ2luZ09wdGlvbnMoc2NvcGU6IENvbnN0cnVjdCwgcHJvcHM6IERlc3RpbmF0aW9uTG9nZ2luZ1Byb3BzKTogRGVzdGluYXRpb25Mb2dnaW5nQ29uZmlnIHwgdW5kZWZpbmVkIHtcbiAgaWYgKHByb3BzLmxvZ2dpbmcgPT09IGZhbHNlICYmIHByb3BzLmxvZ0dyb3VwKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdsb2dnaW5nIGNhbm5vdCBiZSBzZXQgdG8gZmFsc2Ugd2hlbiBsb2dHcm91cCBpcyBwcm92aWRlZCcpO1xuICB9XG4gIGlmIChwcm9wcy5sb2dnaW5nICE9PSBmYWxzZSB8fCBwcm9wcy5sb2dHcm91cCkge1xuICAgIGNvbnN0IGxvZ0dyb3VwID0gcHJvcHMubG9nR3JvdXAgPz8gTm9kZS5vZihzY29wZSkudHJ5RmluZENoaWxkKCdMb2dHcm91cCcpIGFzIGxvZ3MuSUxvZ0dyb3VwID8/IG5ldyBsb2dzLkxvZ0dyb3VwKHNjb3BlLCAnTG9nR3JvdXAnKTtcbiAgICBjb25zdCBsb2dHcm91cEdyYW50ID0gbG9nR3JvdXAuZ3JhbnRXcml0ZShwcm9wcy5yb2xlKTtcbiAgICByZXR1cm4ge1xuICAgICAgbG9nZ2luZ09wdGlvbnM6IHtcbiAgICAgICAgZW5hYmxlZDogdHJ1ZSxcbiAgICAgICAgbG9nR3JvdXBOYW1lOiBsb2dHcm91cC5sb2dHcm91cE5hbWUsXG4gICAgICAgIGxvZ1N0cmVhbU5hbWU6IGxvZ0dyb3VwLmFkZFN0cmVhbShwcm9wcy5zdHJlYW1JZCkubG9nU3RyZWFtTmFtZSxcbiAgICAgIH0sXG4gICAgICBkZXBlbmRhYmxlczogW2xvZ0dyb3VwR3JhbnRdLFxuICAgIH07XG4gIH1cbiAgcmV0dXJuIHVuZGVmaW5lZDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZUJ1ZmZlcmluZ0hpbnRzKFxuICBpbnRlcnZhbD86IGNkay5EdXJhdGlvbixcbiAgc2l6ZT86IGNkay5TaXplLFxuKTogQ2ZuRGVsaXZlcnlTdHJlYW0uQnVmZmVyaW5nSGludHNQcm9wZXJ0eSB8IHVuZGVmaW5lZCB7XG4gIGlmICghaW50ZXJ2YWwgJiYgIXNpemUpIHtcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgY29uc3QgaW50ZXJ2YWxJblNlY29uZHMgPSBpbnRlcnZhbD8udG9TZWNvbmRzKCkgPz8gMzAwO1xuICBpZiAoaW50ZXJ2YWxJblNlY29uZHMgPiA5MDApIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYEJ1ZmZlcmluZyBpbnRlcnZhbCBtdXN0IGJlIGxlc3MgdGhhbiA5MDAgc2Vjb25kcy4gQnVmZmVyaW5nIGludGVydmFsIHByb3ZpZGVkIHdhcyAke2ludGVydmFsSW5TZWNvbmRzfSBzZWNvbmRzLmApO1xuICB9XG4gIGNvbnN0IHNpemVJbk1CcyA9IHNpemU/LnRvTWViaWJ5dGVzKCkgPz8gNTtcbiAgaWYgKHNpemVJbk1CcyA8IDEgfHwgc2l6ZUluTUJzID4gMTI4KSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBCdWZmZXJpbmcgc2l6ZSBtdXN0IGJlIGJldHdlZW4gMSBhbmQgMTI4IE1pQnMuIEJ1ZmZlcmluZyBzaXplIHByb3ZpZGVkIHdhcyAke3NpemVJbk1Cc30gTWlCcy5gKTtcbiAgfVxuICByZXR1cm4geyBpbnRlcnZhbEluU2Vjb25kcywgc2l6ZUluTUJzIH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVFbmNyeXB0aW9uQ29uZmlnKFxuICByb2xlOiBpYW0uSVJvbGUsXG4gIGVuY3J5cHRpb25LZXk/OiBrbXMuSUtleSxcbik6IENmbkRlbGl2ZXJ5U3RyZWFtLkVuY3J5cHRpb25Db25maWd1cmF0aW9uUHJvcGVydHkgfCB1bmRlZmluZWQge1xuICBlbmNyeXB0aW9uS2V5Py5ncmFudEVuY3J5cHREZWNyeXB0KHJvbGUpO1xuICByZXR1cm4gZW5jcnlwdGlvbktleVxuICAgID8geyBrbXNFbmNyeXB0aW9uQ29uZmlnOiB7IGF3c2ttc0tleUFybjogZW5jcnlwdGlvbktleS5rZXlBcm4gfSB9XG4gICAgOiB1bmRlZmluZWQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVQcm9jZXNzaW5nQ29uZmlnKFxuICBzY29wZTogQ29uc3RydWN0LFxuICByb2xlOiBpYW0uSVJvbGUsXG4gIGRhdGFQcm9jZXNzb3I/OiBmaXJlaG9zZS5JRGF0YVByb2Nlc3Nvcixcbik6IENmbkRlbGl2ZXJ5U3RyZWFtLlByb2Nlc3NpbmdDb25maWd1cmF0aW9uUHJvcGVydHkgfCB1bmRlZmluZWQge1xuICByZXR1cm4gZGF0YVByb2Nlc3NvclxuICAgID8ge1xuICAgICAgZW5hYmxlZDogdHJ1ZSxcbiAgICAgIHByb2Nlc3NvcnM6IFtyZW5kZXJEYXRhUHJvY2Vzc29yKGRhdGFQcm9jZXNzb3IsIHNjb3BlLCByb2xlKV0sXG4gICAgfVxuICAgIDogdW5kZWZpbmVkO1xufVxuXG5mdW5jdGlvbiByZW5kZXJEYXRhUHJvY2Vzc29yKFxuICBwcm9jZXNzb3I6IGZpcmVob3NlLklEYXRhUHJvY2Vzc29yLFxuICBzY29wZTogQ29uc3RydWN0LFxuICByb2xlOiBpYW0uSVJvbGUsXG4pOiBDZm5EZWxpdmVyeVN0cmVhbS5Qcm9jZXNzb3JQcm9wZXJ0eSB7XG4gIGNvbnN0IHByb2Nlc3NvckNvbmZpZyA9IHByb2Nlc3Nvci5iaW5kKHNjb3BlLCB7IHJvbGUgfSk7XG4gIGNvbnN0IHBhcmFtZXRlcnMgPSBbeyBwYXJhbWV0ZXJOYW1lOiAnUm9sZUFybicsIHBhcmFtZXRlclZhbHVlOiByb2xlLnJvbGVBcm4gfV07XG4gIHBhcmFtZXRlcnMucHVzaChwcm9jZXNzb3JDb25maWcucHJvY2Vzc29ySWRlbnRpZmllcik7XG4gIGlmIChwcm9jZXNzb3IucHJvcHMuYnVmZmVySW50ZXJ2YWwpIHtcbiAgICBwYXJhbWV0ZXJzLnB1c2goeyBwYXJhbWV0ZXJOYW1lOiAnQnVmZmVySW50ZXJ2YWxJblNlY29uZHMnLCBwYXJhbWV0ZXJWYWx1ZTogcHJvY2Vzc29yLnByb3BzLmJ1ZmZlckludGVydmFsLnRvU2Vjb25kcygpLnRvU3RyaW5nKCkgfSk7XG4gIH1cbiAgaWYgKHByb2Nlc3Nvci5wcm9wcy5idWZmZXJTaXplKSB7XG4gICAgcGFyYW1ldGVycy5wdXNoKHsgcGFyYW1ldGVyTmFtZTogJ0J1ZmZlclNpemVJbk1CcycsIHBhcmFtZXRlclZhbHVlOiBwcm9jZXNzb3IucHJvcHMuYnVmZmVyU2l6ZS50b01lYmlieXRlcygpLnRvU3RyaW5nKCkgfSk7XG4gIH1cbiAgaWYgKHByb2Nlc3Nvci5wcm9wcy5yZXRyaWVzKSB7XG4gICAgcGFyYW1ldGVycy5wdXNoKHsgcGFyYW1ldGVyTmFtZTogJ051bWJlck9mUmV0cmllcycsIHBhcmFtZXRlclZhbHVlOiBwcm9jZXNzb3IucHJvcHMucmV0cmllcy50b1N0cmluZygpIH0pO1xuICB9XG4gIHJldHVybiB7XG4gICAgdHlwZTogcHJvY2Vzc29yQ29uZmlnLnByb2Nlc3NvclR5cGUsXG4gICAgcGFyYW1ldGVycyxcbiAgfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZUJhY2t1cENvbmZpZyhzY29wZTogQ29uc3RydWN0LCByb2xlOiBpYW0uSVJvbGUsIHByb3BzPzogRGVzdGluYXRpb25TM0JhY2t1cFByb3BzKTogRGVzdGluYXRpb25CYWNrdXBDb25maWcgfCB1bmRlZmluZWQge1xuICBpZiAoIXByb3BzIHx8IChwcm9wcy5tb2RlID09PSB1bmRlZmluZWQgJiYgIXByb3BzLmJ1Y2tldCkpIHtcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgY29uc3QgYnVja2V0ID0gcHJvcHMuYnVja2V0ID8/IG5ldyBzMy5CdWNrZXQoc2NvcGUsICdCYWNrdXBCdWNrZXQnKTtcbiAgY29uc3QgYnVja2V0R3JhbnQgPSBidWNrZXQuZ3JhbnRSZWFkV3JpdGUocm9sZSk7XG5cbiAgY29uc3QgeyBsb2dnaW5nT3B0aW9ucywgZGVwZW5kYWJsZXM6IGxvZ2dpbmdEZXBlbmRhYmxlcyB9ID0gY3JlYXRlTG9nZ2luZ09wdGlvbnMoc2NvcGUsIHtcbiAgICBsb2dnaW5nOiBwcm9wcy5sb2dnaW5nLFxuICAgIGxvZ0dyb3VwOiBwcm9wcy5sb2dHcm91cCxcbiAgICByb2xlLFxuICAgIHN0cmVhbUlkOiAnUzNCYWNrdXAnLFxuICB9KSA/PyB7fTtcblxuICByZXR1cm4ge1xuICAgIGJhY2t1cENvbmZpZzoge1xuICAgICAgYnVja2V0QXJuOiBidWNrZXQuYnVja2V0QXJuLFxuICAgICAgcm9sZUFybjogcm9sZS5yb2xlQXJuLFxuICAgICAgcHJlZml4OiBwcm9wcy5kYXRhT3V0cHV0UHJlZml4LFxuICAgICAgZXJyb3JPdXRwdXRQcmVmaXg6IHByb3BzLmVycm9yT3V0cHV0UHJlZml4LFxuICAgICAgYnVmZmVyaW5nSGludHM6IGNyZWF0ZUJ1ZmZlcmluZ0hpbnRzKHByb3BzLmJ1ZmZlcmluZ0ludGVydmFsLCBwcm9wcy5idWZmZXJpbmdTaXplKSxcbiAgICAgIGNvbXByZXNzaW9uRm9ybWF0OiBwcm9wcy5jb21wcmVzc2lvbj8udmFsdWUsXG4gICAgICBlbmNyeXB0aW9uQ29uZmlndXJhdGlvbjogY3JlYXRlRW5jcnlwdGlvbkNvbmZpZyhyb2xlLCBwcm9wcy5lbmNyeXB0aW9uS2V5KSxcbiAgICAgIGNsb3VkV2F0Y2hMb2dnaW5nT3B0aW9uczogbG9nZ2luZ09wdGlvbnMsXG4gICAgfSxcbiAgICBkZXBlbmRhYmxlczogW2J1Y2tldEdyYW50LCAuLi4obG9nZ2luZ0RlcGVuZGFibGVzID8/IFtdKV0sXG4gIH07XG59XG4iXX0=